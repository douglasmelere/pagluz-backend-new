// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String
  name                 String?
  role                 UserRole  @default(ADMIN)
  isActive             Boolean   @default(true)
  lastLoginAt          DateTime?
  loginCount           Int       @default(0)
  failedLoginAttempts  Int       @default(0) // Contador de tentativas de login falhadas
  lockedUntil          DateTime? // Data até quando a conta está bloqueada
  passwordChangedAt    DateTime? // Última vez que a senha foi alterada
  passwordResetToken   String? // Token para reset de senha
  passwordResetExpires DateTime? // Expiração do token de reset
  createdBy            String? // ID do usuário que criou este usuário
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relacionamento com logs de auditoria
  auditLogs              AuditLog[]
  reviewedChangeRequests ConsumerChangeRequest[]

  @@map("users")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String? // ID do usuário que executou a ação (pode ser nulo em eventos anônimos)
  user       User?    @relation(fields: [userId], references: [id])
  action     String // Ação executada (CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.)
  entityType String // Tipo de entidade afetada (User, Consumer, Representative, etc.)
  entityId   String? // ID da entidade afetada (opcional)
  oldValues  Json? // Valores anteriores (para UPDATE)
  newValues  Json? // Novos valores (para CREATE/UPDATE)
  ipAddress  String? // IP do usuário
  userAgent  String? // User agent do navegador
  metadata   Json? // Dados adicionais da ação
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}

model BlacklistedToken {
  id        String   @id @default(cuid())
  token     String   @unique // Hash do token JWT
  userId    String // ID do usuário que fez logout
  expiresAt DateTime // Quando o token expiraria naturalmente
  reason    String // Motivo da invalidação (LOGOUT, SECURITY, etc.)
  createdAt DateTime @default(now())

  @@map("blacklisted_tokens")
}

model Representative {
  id              String               @id @default(cuid())
  name            String
  email           String               @unique
  password        String
  cpfCnpj         String               @unique
  phone           String
  city            String
  state           String
  specializations String[]             @default([])
  status          RepresentativeStatus @default(PENDING_APPROVAL)
  notes           String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  lastLoginAt     DateTime?
  loginCount      Int                  @default(0)

  // Relacionamento com tokens
  representative_tokens representative_tokens[]
  Consumer              Consumer[]
  commissions           Commission[]
  changeRequests        ConsumerChangeRequest[]

  @@map("commercial_representatives")
}

model Consumer {
  id                          String                 @id @default(cuid())
  name                        String
  documentType                DocumentType?          @default(CPF)
  cpfCnpj                     String
  representativeName          String?
  representativeRg            String?
  phone                       String?                @default("")
  email                       String?                @default("")
  concessionaire              String
  ucNumber                    String
  consumerType                ConsumerType
  phase                       PhaseType
  averageMonthlyConsumption   Float
  discountOffered             Float
  receiveWhatsapp             Boolean                @default(false)
  street                      String?                @default("")
  number                      String?                @default("")
  complement                  String?
  neighborhood                String?                @default("")
  city                        String
  state                       String
  zipCode                     String?                @default("")
  birthDate                   DateTime?
  observations                String?
  arrivalDate                 DateTime?
  status                      ConsumerStatus         @default(AVAILABLE)
  allocatedPercentage         Float?
  generatorId                 String?
  // Approval workflow fields
  approvalStatus              ConsumerApprovalStatus @default(PENDING)
  submittedByRepresentativeId String?
  approvedByUserId            String?
  approvedAt                  DateTime?
  rejectionReason             String?

  // Invoice fields
  invoiceUrl         String? // URL da fatura no Supabase Storage
  invoiceFileName    String? // Nome do arquivo original
  invoiceUploadedAt  DateTime? // Data do upload
  invoiceScannedData Json? // Dados extraídos do OCR (opcional)

  // Relacionamento com gerador
  generator Generator? @relation(fields: [generatorId], references: [id])

  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  Representative   Representative?         @relation(fields: [representativeId], references: [id])
  representativeId String?
  commissions      Commission[]
  changeRequests   ConsumerChangeRequest[] // Mudanças pendentes de aprovação

  @@map("consumers")
}

model Generator {
  id             String          @id @default(cuid())
  ownerName      String
  cpfCnpj        String
  sourceType     SourceType
  installedPower Float
  concessionaire String
  ucNumber       String
  city           String
  state          String
  status         GeneratorStatus @default(UNDER_ANALYSIS)
  observations   String?

  // Relacionamento com consumidores
  consumers Consumer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("generators")
}

model representative_tokens {
  id                         String         @id
  token                      String         @unique
  representativeId           String
  expiresAt                  DateTime
  isRevoked                  Boolean        @default(false)
  createdAt                  DateTime       @default(now())
  commercial_representatives Representative @relation(fields: [representativeId], references: [id], onDelete: Cascade)
}

model Commission {
  id               String           @id @default(cuid())
  representativeId String
  consumerId       String
  kwhConsumption   Float // Consumo em kWh do consumidor
  kwhPrice         Float // Preço do kWh no momento do cálculo
  commissionValue  Float // Valor da comissão calculada
  status           CommissionStatus @default(PENDING)
  calculatedAt     DateTime         @default(now())
  paidAt           DateTime?
  notes            String?

  // Campos para comprovante de pagamento
  paymentProofUrl        String? // URL do comprovante no Supabase Storage
  paymentProofFileName   String? // Nome do arquivo original
  paymentProofUploadedAt DateTime? // Data do upload do comprovante

  // Relacionamentos
  representative Representative @relation(fields: [representativeId], references: [id], onDelete: Cascade)
  consumer       Consumer       @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("commissions")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model ConsumerChangeRequest {
  id               String         @id @default(cuid())
  consumerId       String
  consumer         Consumer       @relation(fields: [consumerId], references: [id], onDelete: Cascade)
  representativeId String // Representante que solicitou a mudança
  representative   Representative @relation(fields: [representativeId], references: [id])

  // Dados da mudança
  oldValues     Json? // Valores antigos
  newValues     Json // Novos valores propostos
  changedFields String[] // Lista de campos alterados

  // Status da aprovação
  status      ChangeRequestStatus @default(PENDING)
  requestedAt DateTime            @default(now())

  // Aprovação/Rejeição
  reviewedByUserId String? // Admin que revisou
  reviewedBy       User?     @relation(fields: [reviewedByUserId], references: [id])
  reviewedAt       DateTime?
  rejectionReason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("consumer_change_requests")
}

enum UserRole {
  SUPER_ADMIN // Apenas Douglas
  ADMIN // Usuários de nível alto (podem fazer tudo menos criar users)
  MANAGER // Usuários de nível médio (podem gerenciar representantes e consumidores)
  OPERATOR // Usuários de nível baixo (podem apenas visualizar e editar dados básicos)
  REPRESENTATIVE
}

enum RepresentativeStatus {
  ACTIVE
  INACTIVE
  PENDING_APPROVAL
  SUSPENDED
}

enum ConsumerType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  RURAL
  PUBLIC_POWER
}

enum PhaseType {
  MONOPHASIC
  BIPHASIC
  TRIPHASIC
}

enum ConsumerStatus {
  AVAILABLE
  ALLOCATED
  IN_PROCESS
  CONVERTED
}

enum ConsumerApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SourceType {
  SOLAR
  HYDRO
  BIOMASS
  WIND
}

enum GeneratorStatus {
  UNDER_ANALYSIS
  AWAITING_ALLOCATION
  ACTIVE
  INACTIVE
}

enum CommissionStatus {
  PENDING
  CALCULATED
  PAID
  CANCELLED
}

enum DocumentType {
  CPF
  CNPJ
}

enum ChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
